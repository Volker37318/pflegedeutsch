<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PflegeDeutsch – Klassencode Generator</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a2e;
      --card2:#0f1730;
      --text:#e8eefc;
      --text2:#c8d4f3;
      --muted:#7082a0;
      --line:rgba(148,161,255,.14);
      --accent:#7aa2ff;
      --accent2:#69e2d3;
      --danger:#ff6b6b;
      --ok:#46d27a;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f8ff;
        --card:#ffffff;
        --card2:#f7f9ff;
        --text:#10152a;
        --text2:#2a3555;
        --muted:#6a7696;
        --line:rgba(30,50,110,.12);
        --accent:#2a5cff;
        --accent2:#0ea5a7;
        --danger:#d83b3b;
        --ok:#0f9d58;
        --shadow:0 10px 30px rgba(18,28,54,.12);
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(122,162,255,.35), transparent 55%),
                  radial-gradient(900px 500px at 90% 0%, rgba(105,226,211,.28), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.45;
    }
    .wrap{max-width:980px;margin:0 auto;padding:28px 16px 60px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(122,162,255,1), rgba(105,226,211,1));
      box-shadow: var(--shadow);
    }
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr;gap:16px}
    @media (max-width:880px){.grid{grid-template-columns:1fr}}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent 55%), var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .card h2{font-size:16px;margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:180px}
    label{font-size:12px;color:var(--muted)}
    input,select,button,textarea{
      font:inherit;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    input::placeholder,textarea::placeholder{color:rgba(200,212,243,.55)}
    @media (prefers-color-scheme: light){
      input,select,button,textarea{background:#fff}
      input::placeholder,textarea::placeholder{color:rgba(42,53,85,.5)}
    }
    button{
      cursor:pointer;
      background: linear-gradient(135deg, rgba(122,162,255,.95), rgba(105,226,211,.90));
      color: #081022;
      border:none;
      font-weight: 650;
      box-shadow: 0 8px 20px rgba(40,90,255,.25);
    }
    button.secondary{
      background: rgba(255,255,255,.06);
      color:var(--text);
      border:1px solid var(--line);
      box-shadow:none;
      font-weight: 600;
    }
    button.danger{
      background: rgba(255,107,107,.16);
      color:var(--text);
      border:1px solid rgba(255,107,107,.25);
      box-shadow:none;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text2);
      font-size:12px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .sep{height:1px;background:var(--line);margin:14px 0}
    .out{
      padding:14px;
      border-radius:14px;
      border:1px dashed rgba(122,162,255,.35);
      background: rgba(122,162,255,.07);
    }
    .out .k{color:var(--muted);font-size:12px;margin-bottom:6px}
    .out .v{font-size:18px;font-weight:750}
    .small{font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)}
    .bad{color:var(--danger)}
    .hidden{display:none!important}
    .rightActions{display:flex;gap:10px;align-items:center;justify-content:flex-end}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .table th,.table td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
    .table th{color:var(--muted);font-weight:650}
    .copyRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .copyRow input{flex:1;min-width:200px}
    .msg{font-size:13px;margin-top:10px}
    .msg .ok{font-weight:700}
    .msg .bad{font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>PflegeDeutsch</h1>
          <div class="sub">Klassencode & Teilnehmercode Generator (Teacher Login)</div>
        </div>
      </div>
      <div class="rightActions">
        <span id="teacherState" class="pill">Teacher: <span class="bad">nicht angemeldet</span></span>
        <button id="logoutBtn" class="secondary hidden">Logout</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>1) Teacher Anmeldung</h2>
        <div class="row">
          <div class="field">
            <label for="pin">Teacher PIN</label>
            <input id="pin" type="password" inputmode="numeric" placeholder="PIN eingeben…" autocomplete="off" />
          </div>
          <button id="btnLogin">Login</button>
        </div>
        <div id="loginMsg" class="msg"></div>

        <div class="sep"></div>

        <h2>2) Klassencode erstellen</h2>
        <div class="small">Nur sichtbar nach erfolgreichem Teacher Login.</div>

        <div id="appArea" class="hidden">
          <div class="row" style="margin-top:10px">
            <div class="field">
              <label for="course">Kurs/Bezeichnung</label>
              <input id="course" placeholder="z.B. Pflege 1A – Grammatik" />
            </div>
            <div class="field">
              <label for="teacher">Lehrkraft</label>
              <input id="teacher" placeholder="z.B. Volker" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="field">
              <label for="maxStudents">Teilnehmeranzahl</label>
              <input id="maxStudents" type="number" min="1" max="999" value="30" />
            </div>
            <div class="field">
              <label for="validDays">Gültig (Tage)</label>
              <input id="validDays" type="number" min="1" max="365" value="30" />
            </div>
            <button id="btnGen" title="Erzeugt Klassencode + Teilnehmercode">Erstellen</button>
          </div>

          <div class="sep"></div>

          <div class="out">
            <div class="k">Klassencode</div>
            <div id="classCode" class="v mono">—</div>
            <div class="small">Wird benötigt, um Teilnehmercodes zu erzeugen.</div>
          </div>

          <div style="height:10px"></div>

          <div class="out">
            <div class="k">Teilnehmercode (Beispiel)</div>
            <div id="studentCode" class="v mono">—</div>
            <div class="small">Für jeden Teilnehmer kann ein eigener Code generiert werden.</div>
          </div>

          <div style="height:10px"></div>

          <div class="out">
            <div class="k">Teilnehmer-Link</div>
            <div class="copyRow">
              <input id="joinLink" readonly />
              <button id="btnCopy" class="secondary">Kopieren</button>
            </div>
            <div class="small">Link kann an Teilnehmer gesendet werden.</div>
          </div>

          <div class="sep"></div>

          <h2>3) Gespeicherte Klassen (lokal)</h2>
          <div class="small">Gespeichert im Browser (localStorage). Nicht serverseitig.</div>

          <table class="table" id="classesTable" style="margin-top:8px">
            <thead>
              <tr>
                <th>Kurs</th>
                <th>Lehrer</th>
                <th>Klassencode</th>
                <th>Gültig bis</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div style="margin-top:10px" class="row">
            <button id="btnClear" class="danger">Alle lokalen Klassen löschen</button>
            <span class="small">Achtung: Nur lokal im Browser.</span>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h2>Info</h2>
        <p class="small">
          Teacher Login nutzt eine Netlify Function mit httpOnly Cookie Session.
          Diese Seite zeigt erst nach Login den Generator.
        </p>
        <div class="sep"></div>

        <h2>Endpunkte</h2>
        <div class="small mono">
          GET /.netlify/functions/teacher-auth → Session check<br/>
          POST /.netlify/functions/teacher-auth → Login { pin }<br/>
          GET /.netlify/functions/teacher-auth?logout=1 → Logout
        </div>

        <div class="sep"></div>

        <h2>Hinweis</h2>
        <p class="small">
          Wenn du lokale Tests machst, nutze am besten <span class="mono">netlify dev</span>.
          Dann funktionieren die Functions wie online.
        </p>
      </div>
    </div>
  </div>

  <script>
    const BASE = window.location.origin; // robust für jede Netlify-Domain

    // Wenn wir mit ?next=dashboard kommen, leiten wir nach erfolgreichem Login weiter
    const NEXT = new URLSearchParams(window.location.search).get("next");
    function goNextIfWanted(){
      if (NEXT === "dashboard") {
        window.location.replace("/dashboard/");
        return true;
      }
      return false;
    }

    const $ = (id)=>document.getElementById(id);

    const teacherState = $("teacherState");
    const logoutBtn = $("logoutBtn");
    const appArea = $("appArea");
    const loginMsg = $("loginMsg");

    const STORAGE_KEY = "pd_classes_v1";

    function showMsg(el, text, ok){
      el.innerHTML = ok ? `<span class="ok">${text}</span>` : `<span class="bad">${text}</span>`;
    }

    function setTeacherUI(isAuthed){
      teacherState.innerHTML = `Teacher: ${isAuthed ? `<span class="ok">angemeldet</span>` : `<span class="bad">nicht angemeldet</span>`}`;
      logoutBtn.classList.toggle("hidden", !isAuthed);
      appArea.classList.toggle("hidden", !isAuthed);
      if(!isAuthed) showMsg(loginMsg, "Bitte Teacher PIN eingeben.", false);
    }

    async function checkSession(){
      try{
        const r = await fetch(`${BASE}/.netlify/functions/teacher-auth`, {
          method:"GET",
          credentials:"include",
          headers:{ "Accept":"application/json" }
        });
        const data = await r.json().catch(()=>({}));
        if(!r.ok) {
          showMsg(loginMsg, `Session-Check fehlgeschlagen: ${data.error || r.status}`, false);
          setTeacherUI(false);
          return false;
        }
        const authed = !!data.authenticated;
        setTeacherUI(authed);
        return authed;
      }catch(e){
        showMsg(loginMsg, `Session-Check Fehler: ${e.message}`, false);
        setTeacherUI(false);
        return false;
      }
    }

    async function loginWithPin(pin){
      try{
        const r = await fetch(`${BASE}/.netlify/functions/teacher-auth`, {
          method:"POST",
          credentials:"include",
          headers:{ "Content-Type":"application/json", "Accept":"application/json" },
          body: JSON.stringify({ pin })
        });
        const data = await r.json().catch(()=>({}));
        if(!r.ok){
          showMsg(loginMsg, data.error || `Login fehlgeschlagen (${r.status})`, false);
          return false;
        }
        showMsg(loginMsg, "OK. Angemeldet.", true);
        setTeacherUI(true);
        return true;
      }catch(e){
        showMsg(loginMsg, `Login Fehler: ${e.message}`, false);
        return false;
      }
    }

    async function logout(){
      try{
        await fetch(`${BASE}/.netlify/functions/teacher-auth?logout=1`, {
          method:"GET",
          credentials:"include"
        });
      }catch{}
      setTeacherUI(false);
      showMsg(loginMsg, "Abgemeldet.", true);
      window.location.replace("/");
    }

    // ===== Generator / Codes =====

    function randCode(len=8){
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let s = "";
      crypto.getRandomValues(new Uint32Array(len)).forEach(v=>{
        s += chars[v % chars.length];
      });
      return s;
    }

    // Teilnehmercode deterministisch aus Klassencode + Index (für Demo / reproducible)
    function pin4From(str){
      let h = 2166136261;
      for (let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      const n = (h >>> 0) % 10000;
      return String(n).padStart(4,"0");
    }

    function loadClasses(){
      try{
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      }catch{
        return [];
      }
    }
    function saveClasses(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function fmtDate(ts){
      const d = new Date(ts);
      return d.toLocaleDateString("de-DE");
    }

    function renderTable(){
      const tbody = $("classesTable").querySelector("tbody");
      tbody.innerHTML = "";
      const arr = loadClasses();
      if(arr.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" class="small">Noch keine Klassen gespeichert.</td>`;
        tbody.appendChild(tr);
        return;
      }
      for(const item of arr){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(item.course || "")}</td>
          <td>${escapeHtml(item.teacher || "")}</td>
          <td class="mono">${escapeHtml(item.classCode)}</td>
          <td>${fmtDate(item.validUntil)}</td>
          <td><button class="secondary" data-use="${item.classCode}">Use</button></td>
        `;
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll("button[data-use]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const code = btn.getAttribute("data-use");
          applyClassCode(code);
        });
      });
    }

    function escapeHtml(s){
      return String(s || "").replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function applyClassCode(classCode){
      $("classCode").textContent = classCode;
      const studentExample = pin4From(classCode + ":1");
      $("studentCode").textContent = studentExample;
      const link = `${BASE}/?join=1&class=${encodeURIComponent(classCode)}&code=${encodeURIComponent(studentExample)}`;
      $("joinLink").value = link;
    }

    function enterApp(){
      // UI already toggled via setTeacherUI(true)
      renderTable();
    }

    // ===== events =====
    window.addEventListener("DOMContentLoaded", async ()=>{
      $("btnLogin").addEventListener("click", async ()=>{
        const pin = $("pin").value.trim();
        if(!pin){
          showMsg(loginMsg, "Bitte PIN eingeben.", false);
          return;
        }
        const ok = await loginWithPin(pin);
        if(ok){
          enterApp();
          goNextIfWanted();
        }
      });

      $("pin").addEventListener("keydown", (e)=>{
        if(e.key === "Enter") $("btnLogin").click();
      });

      logoutBtn.addEventListener("click", logout);

      $("btnGen").addEventListener("click", ()=>{
        const course = $("course").value.trim();
        const teacher = $("teacher").value.trim();
        const maxStudents = Math.max(1, Math.min(999, parseInt($("maxStudents").value || "30", 10)));
        const validDays = Math.max(1, Math.min(365, parseInt($("validDays").value || "30", 10)));

        const classCode = randCode(10);
        const validUntil = Date.now() + validDays * 24*60*60*1000;

        const entry = { course, teacher, maxStudents, validDays, classCode, validUntil, createdAt: Date.now() };
        const arr = loadClasses();
        arr.unshift(entry);
        saveClasses(arr);

        applyClassCode(classCode);
        renderTable();
      });

      $("btnCopy").addEventListener("click", async ()=>{
        const v = $("joinLink").value;
        if(!v) return;
        try{
          await navigator.clipboard.writeText(v);
          showMsg(loginMsg, "Link kopiert.", true);
        }catch{
          showMsg(loginMsg, "Kopieren nicht möglich (Browser-Rechte).", false);
        }
      });

      $("btnClear").addEventListener("click", ()=>{
        if(!confirm("Wirklich alle lokal gespeicherten Klassen löschen?")) return;
        localStorage.removeItem(STORAGE_KEY);
        renderTable();
      });

      // initial session check
      const authed = await checkSession();
      if(authed){
        enterApp();
        goNextIfWanted();
      }
    });
  </script>
</body>
</html>

